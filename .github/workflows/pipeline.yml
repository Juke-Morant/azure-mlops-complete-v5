
name: Final-Fixed-Pipeline-V2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  full-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure ML CLI
        run: az extension add -n ml

      # 1. è®­ç»ƒ
      - name: Submit Training Job
        run: az ml job create --file src/job.yml --resource-group FirstResource --workspace-name AzureML

      # 2. æ³¨å†Œ (è‡ªåŠ¨ç‰ˆæœ¬)
      - name: Register Model
        run: |
          echo "Dummy model content" > model.pkl
          az ml model create --name mlops-demo-model --path model.pkl --resource-group FirstResource --workspace-name AzureML

      # 3. åˆ›å»º Endpoint
      - name: Create Endpoint
        run: |
          az ml online-endpoint create --file endpoint/endpoint.yml --resource-group FirstResource --workspace-name AzureML || echo "Endpoint å·²å­˜åœ¨"

      # 4. åˆ›å»º Deployment (âš ï¸ è¿™ä¸€æ­¥å»æ‰äº† --all-traffic)
      - name: Create Deployment
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²è™šæ‹Ÿæœº (é¢„è®¡ 10 åˆ†é’Ÿ)..."
          az ml online-deployment create --file endpoint/deployment.yml --resource-group FirstResource --workspace-name AzureML

      # 5. åˆ†é…æµé‡ (âš ï¸ è¿™æ˜¯æ–°å¢çš„å•ç‹¬ä¸€æ­¥)
      - name: Allocate Traffic
        run: |
          echo "ğŸ”€ æ­£åœ¨å°† 100% æµé‡åˆ‡æ¢åˆ° blue..."
          az ml online-endpoint update --name juke-final-ep-2026 --traffic "blue=100" --resource-group FirstResource --workspace-name AzureML
